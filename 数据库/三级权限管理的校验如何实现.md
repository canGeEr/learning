# 三级权限管理的校验如何实现

**分析权限的实际意义和期望解决的问题**：

1. 权限管理事实上是为了规范用户对接口的访问权限（保证数据库的安全），因此本质上是说用户能够访问那些接口
2. 但是从业务上看，真正落地的使用系统的人员，无论是查看、删除、修改 用户 <=> 接口 的关系都不是清晰和明确的，要解决这个根本问题需要进一步将接口抽象更加贴近非开发人员的词 => 角色
3. 角色可以理解是接口权限组，是多个接口权限的打包，比如说 管理员就是所有接口都可以访问的角色，是所有接口的集合

思考，用户 <=> 角色 <=> 接口，真的好管理吗

## 资源

- role 角色
- permission 权限
- user 用户

## 资源关系

一个用户对应 N 个角色，一个角色对应 N 个权限，分别增加 user_role 表和 role_permission 表

## permission 为什么要落地成树结构

> 业务侧：对真正使用系统的人员来说，他对权限的关注情景在于，如果你是一个没有权限的用户，那么当你进入到**某些页面**，看不到**某些元素和按钮**

所以对于用户来说，接口的权限应该按照页面进行最基本划分，也就是说，某些接口在某个页面需要进行鉴权校验，更甚至某些页面用户无法访问

我们这里直接的用树去做分类：大概分三级：

- 一级菜单 菜单显示权限
- 二级菜单 菜单显示权限
- 三级按钮 菜单下的所有权限点，没有权限点无法显示操作按钮。一、二级菜单是为了控制某些页面是否能够进入

思考和总结：

- 多层级的权限结构，会导致最终校验用户的权限点大于等于程序暴露的接口，多出来的那部分就是页面路由的访问权限
- 三级按钮就是对应一个接口权限吗？不是的，在实际的使用过程中，很多功能点涉及到多个接口一起调用，所以一个权限点最好能够覆盖多个接口（业务侧）

## permission 疑问

> 后端的权限管理本身是投射到前端的页面上，对于前端来说，权限是决定用户是否能使用某些功能，具体的场景：在某个页面下、对于某种用户没有权限查看/操作某些入口

- 权限树只能有三级吗？：不是的，权限树可以 N 层级，甚至可以没有层级，有层级只是为了方便管理，对后台管理来说，如果扁平化的权限列表名称特别长，查找繁琐

- 后端怎么使用权限校验呢？：假设是后台管理系统场景
  - 用户登入，进行管理后台，获取用户信息，获取用户的所有角色，获取用户的所有权限（用户、角色、权限 三表同时连接），权限也是一棵树
  - 前端根据返回的权限树，和当前的路由进行合并对比，深度遍历，关键点在于怎么一一对应呢？（我们组的管理端的项目：在菜单权限中设置一个 Path 的路径，这个路径和前端本地的路径是一一对应的），有权限的路由才会被保留下来
  - 当前端的用户真正发起一个请求的时候，后端怎么去校验用户是否有权限进行该操作呢？ => 是否有改接口的鉴权校验，拿到用户的所有权限点下的所有接口校验路径，如果跟当前的接口不符合的话就是错误的，返回不允许用户访问

## B 端和 C 端的权限分开管理

可以将两个权限管理分开存储，设置一个 type 的值，表示是 B 端还是 C 端

## 真正的权限表应该有那些字段，怎么设计呢？

| 字段 | comment |
|  ----  | ----  |
| id | 自增主键 |
| type | 权限系统分类 |
| path | 数节点路径 |
| name | 权限名称 |
| zn_name | 展示中文名 |
| func_type | 功能类型，菜单还是按钮 |
| page_url | 菜单对应的url权限校验 |
| api_list_json | 菜单对应的url权限校验 |
| sort | 排序值 |