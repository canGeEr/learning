# 03-先从文件的下载和解析时机开始聊起
> 基本的查阅资料
- [浏览器的工作原理：新式网络浏览器幕后揭秘](https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/) 
- **浏览器输入url发生了什么** 这个系列其实就涉及到这一环：浏览器解析文件

## 主线程解析时干了什么
![流程图](https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/flow.png)

- 呈现引擎将开始解析 HTML 文档，并将各标记逐个转化成“内容树”上的 DOM 节点。同时也会解析外部 CSS 文件以及样式元素中的样式数据。HTML 中这些带有视觉指令的样式信息将用于创建另一个树结构：呈现树。

- 呈现树包含多个带有视觉属性（如颜色和尺寸）的矩形。这些矩形的排列顺序就是它们将在屏幕上显示的顺序。

- 呈现树构建完毕之后，进入“布局”处理阶段，也就是为每个节点分配一个应出现在屏幕上的确切坐标。下一个阶段是绘制 - 呈现引擎会遍历呈现树，由用户界面后端层将每个节点绘制出来。

- **要着重指出的是**，这是一个渐进的过程。为达到更好的用户体验，呈现引擎会力求尽快将内容显示在屏幕上。它不必等到整个 HTML 文档解析完毕之后，就会开始构建呈现树和设置布局。在不断接收和处理来自网络的其余内容的同时，呈现引擎会将部分内容解析并显示出来.。   
比如：当HTML太大，如果有一个10000行代码的html，它会在解析大约3500行，强制停止HTML的解析，但是不会跳过Parse CSS，最后进行layout，多次循环处理，进行多轮的Parse HTML

![整个流程图](https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/webkitflow.png)


## 脚本和样式表的顺序
> 前面说过浏览器是**有能力边资源下载和边解析，并且资源下载可以多线程并行下载**，但是为什么会有阻塞现象呢？

- **第一点：为什么推荐脚本放最后**    
  
  解析器遇到 script 立即停止文档的解析并执行脚本,直到脚本执行完毕。如果脚本是外部的，那么解析过程会停止，直到从网络同步抓取资源完成后再继续，此模型已经使用了多年，后来做了优化 **预解析**：在执行脚本时，其他线程会扫描文档的其余部分，找出并加载需要通过网络下载（加载）的其他资源（外部脚本、样式表和图片），**但是依然无法执行其它资源的解析**。
  
  浏览器现在允许并行下载 JavaScript 文件。遗憾的是，JavaScript 下载过程仍然会阻塞其他资源的下载，比如样式文件和图片。因此推荐将所有 script 标签尽可能放到 body 标签的底部，以尽量减少对整个页面其它资源下载的影响

  最后 HTML4 和 HTML5 规范中进行了指定。作者也可以将脚本标注为延时"defer"，这样它就不会停止文档解析，而是等到解析结束才执行。HTML5 增加了一个选项，可将脚本标记为异步"async"，以便由其他线程解析和执行

- **第二点：为什么推荐样式放最前**    
  样式表不会阻塞DOM tree地构建，但脚本在文档解析阶段会请求样式信息。如果当时还没有加载和解析样式，脚本就会获得错误的回复，这样显然会产生很多问题。样式可能会阻塞到JS的解析，因此应该尽早地放前



## efer，async脚本下载和执行时机

1. defer 下载不会阻塞其它资源解析，直到下载完成也不会立即执行，等到文档被完全解析和显示，再执行。defer会按照原来在HTML中的顺序执行
2. async 下载不会阻塞其它资源解析，一旦下载完成立即执行。async不会按照HTML的解析他们的顺序执行，因此async的文件不要对其它文件依赖


## onreadystatechange 、load、DOMContentLoaded 执行顺序 
readystate: interactive 开始
DOMContentLoaded DOM Tree建立完成(HTML完全被加载并解析)    
readystate: complete  结束
load  所有资源加载完成包括样式、图片  