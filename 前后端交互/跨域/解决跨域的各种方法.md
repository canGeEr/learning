# 解决跨域的各种方法

## jsonp
- 优点：
    - 兼容性好
- 缺点：
    - 只用于get请求
    - get请求可能导致缓存（如果有必要加上随机字串）
### jsonp原理
主要是利用script标签发起get请求没有跨域限制，服务器返回js代码脚本，浏览器获取并执行脚本以完成回调。后端的数据转换为json字符串作为实参传入回调函数
```javascript
function jsonp({url, callbackName, successFun, params}) {
    const jsonpScript = document.createElement('script')
    //防止首屏阻塞DOM
    jsonpScript.async = true
    //告知后端需要回调什么函数名
    params.callback = callbackName
    jsonpScript.src = serialize({url, params})
    jsonpScript.type = 'text/javascript'
    window[callbackName] = function(data) {
        successFun && successFun(data)
    }
    //真正到页面上才会发出请求
    document.body.appendChild(successFun)
}

//反序列化
function deSerialize(url) {
    let temp = url.split('?')
    let prefixUrl = temp[0]
    let paramsArr = temp[1].split('&')
    let params = {}
    for(let item of paramsArr) {
        temp = item.split('=')
        params[temp[0]] = temp[1]
    }
    return {
        params,
        url: prefixUrl
    }
}

//序列化
function serialize({url, params}) {
    let str = url + '?'
    for(let pro in params) {
        str += pro + '=' + params[pro] + '&'
    }
    return str.slice(0, -1)
}
```
## CORS
CORS （Cross-Origin Resource Sharing，跨域资源共享）是一个系统，它由一系列传输的HTTP头组成，这些HTTP头决定浏览器是否阻止前端 JavaScript 代码获取跨域请求的响应。
主要涉及：
- 客户端：
    - 请求报文字段：Origin
    - 是否允许请求携带凭证：ajax的withCredentials属性（fetch和axios都是如此）
- 服务端响应报文字段：
    - Access-Control-Allow-Origin 运行跨域的源
    - Access-Control-Allow-Credentials 是否允许携带凭证

## 实现
CORS 主要靠后端实现，后端设置Access-Control-Allow-Origin 开启跨域模式，指定允许跨域的站点

- Access-Control-Allow-Origin如果设置通配符允许所有站点访问，但是设置通配符会和Access-Control-Allow-Credentials为true（**是否允许携带cookie**）冲突，
- 前端要携带cookie的话前端的withCredentials设置true，后端...Allow-Origin不能设置通配符，必须指定域名，并且...Allow-Credentials设置为true

但是这样的话有个问题就是：后端只能预先的指定跨域的域名    

因此，我们就**动态的设置允许跨域字段**（前面说了，前端请求跨域自动带上Origin字段，那么后端每次判断的时候，自动设置该值写入...Allow-Origin）


## 二级域名
如果两个站点的二级域名相同，那么可以设置该页面的document.domain=二级域名：
```javascript
//home.shepiji.top、books.shepiji.top
document.domain = 'shepiji.top'
```

## iframe跨域
在iframe篇讲的挺详细的可以参考：
[iframe](./../../JAVASCRIPT/ES6之前/07-iframe.md)

## nginx代理
先留个坑，等我学完再来~