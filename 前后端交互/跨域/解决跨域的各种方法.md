# 解决跨域的各种方法

## jsonp

- 优点：
  - 兼容性好
- 缺点：
  - 只用于 get 请求
  - get 请求可能导致缓存（如果有必要加上随机字串）

### jsonp 原理

主要是利用 script 标签发起 get 请求没有跨域限制，服务器返回 js 代码脚本，浏览器获取并执行脚本以完成回调。后端的数据转换为 json 字符串作为实参传入回调函数

```javascript
function jsonP(url, options = {}) {
  const { onSuccess, onFail, params = {} } = options;
  // 像express直接内置jsonp方法，识别query的callback
  const callback = `jsonp_${new Date().getTime()}`;
  url = generateUrl(url, {
    ...params,
    callback,
  });
  const script = document.createElement("script");
  script.type = "text/javascript";
  script.async = true;
  script.src = url;
  // 挂载回调函数到window上
  Object.defineProperty(window, callback, {
    value: (res) => {
      onSuccess?.(res);
      clear();
    },
    writable: false,
    enumerable: false,
    configurable: true,
  });
  script.onerror = function (event) {
    onFail?.(event);
    clear();
  };
  // 插入开始生效
  document.body.appendChild(script);

  function clear() {
    document.body.removeChild(script);
    delete window[callback];
  }
}

function generateUrl(url, params) {
  const urlParser = new URL(url);
  const { searchParams } = urlParser;
  for (let key of Object.keys(params)) {
    searchParams.append(key, params[key]);
  }
  return urlParser.toString();
}

jsonP("http://localhost:3000/jsonp?a=1", {
  onFail(error) {
    console.log(error);
  },
  onSuccess(res) {
    console.log(res);
  },
  params: {
    username: "shepijcanwu",
  },
});
```

## CORS

CORS （Cross-Origin Resource Sharing，跨域资源共享）是一个系统，它由一系列传输的 HTTP 头组成，这些 HTTP 头决定浏览器是否阻止前端 JavaScript 代码获取跨域请求的响应。
主要涉及：

- 客户端：
  - 请求报文字段：Origin
  - 是否允许请求携带凭证：ajax 的 withCredentials 属性（fetch 和 axios 都是如此）
- 服务端响应报文字段：
  - Access-Control-Allow-Origin 运行跨域的源
  - Access-Control-Allow-Credentials 是否允许携带凭证

## 实现

CORS 主要靠后端实现，后端设置 Access-Control-Allow-Origin 开启跨域模式，指定允许跨域的站点

- Access-Control-Allow-Origin 如果设置通配符允许所有站点访问，但是设置通配符会和 Access-Control-Allow-Credentials 为 true（**是否允许携带 cookie**）冲突，
- 前端要携带 cookie 的话前端的 withCredentials 设置 true，后端...Allow-Origin 不能设置通配符，必须指定域名，并且...Allow-Credentials 设置为 true

但是这样的话有个问题就是：后端只能预先的指定跨域的域名

因此，我们就**动态的设置允许跨域字段**（前面说了，前端请求跨域自动带上 Origin 字段，那么后端每次判断的时候，自动设置该值写入...Allow-Origin）

## 二级域名

如果两个站点的二级域名相同，那么可以设置该页面的 document.domain=二级域名：

```javascript
//home.shepiji.top、books.shepiji.top
document.domain = "shepiji.top";
```

## iframe 跨域

在 iframe 篇讲的挺详细的可以参考：
[iframe](./../../JAVASCRIPT/ES6之前/07-iframe.md)

## nginx 代理

先留个坑，等我学完再来~
